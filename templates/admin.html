<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸŒŒ Galaxy Admin Panel</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#06001a;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;color:#f1f5f9;min-height:100vh}
:root{--purple:#a855f7;--pink:#ec4899;--blue:#60a5fa;--cyan:#22d3ee;--green:#4ade80;--yellow:#facc15;--red:#f87171;--muted:#94a3b8;--border:rgba(168,85,247,0.22);--card:rgba(168,85,247,0.08)}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Login */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
#main-screen{display:none;animation:fadeIn .4s ease}

/* Header */
.header{background:rgba(6,0,26,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header h1{font-size:18px;font-weight:800}
.header p{color:var(--muted);font-size:12px}
.logout-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px}

/* Layout */
.container{padding:24px;max-width:1200px;margin:0 auto}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center}
.stat-card .num{font-size:28px;font-weight:800;margin:4px 0}
.stat-card .lbl{color:var(--muted);font-size:11px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px}
.card-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* Table */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase}
td{padding:10px 12px;border-bottom:1px solid rgba(168,85,247,.1);vertical-align:top}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(168,85,247,.05)}

/* User row */
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.user-cell{display:flex;align-items:center;gap:10px}
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600}
.badge-purple{background:rgba(168,85,247,.2);color:var(--purple)}
.badge-green{background:rgba(74,222,128,.2);color:var(--green)}
.badge-blue{background:rgba(96,165,250,.2);color:var(--blue)}
.badge-pink{background:rgba(236,72,153,.2);color:var(--pink)}
.badge-yellow{background:rgba(250,204,21,.2);color:var(--yellow)}

/* User detail */
.detail-btn{background:rgba(168,85,247,.15);border:1px solid var(--border);border-radius:8px;padding:5px 12px;color:var(--purple);cursor:pointer;font-size:12px;font-weight:600}
.detail-panel{display:none;margin-top:12px;padding:14px;background:rgba(0,0,0,.3);border-radius:12px;border:1px solid var(--border)}
.detail-panel.open{display:block}
.detail-section{margin-bottom:14px}
.detail-section h4{color:var(--muted);font-size:11px;text-transform:uppercase;margin-bottom:8px}
.detail-item{padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
.detail-item:last-child{border-bottom:none}

/* Search */
.search-bar{background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:10px;padding:10px 16px;color:#f1f5f9;outline:none;width:100%;font-size:14px;margin-bottom:16px}
.search-bar::placeholder{color:var(--muted)}

/* Login form */
.login-card{width:100%;max-width:360px;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center}
.login-card .emoji{font-size:56px;margin-bottom:12px;filter:drop-shadow(0 0 20px rgba(168,85,247,.6))}
.login-card h2{font-size:22px;font-weight:800;margin-bottom:4px}
.login-card p{color:var(--muted);font-size:13px;margin-bottom:24px}
.inp{background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:10px;padding:11px 16px;color:#f1f5f9;outline:none;width:100%;font-size:14px;margin-bottom:12px}
.inp::placeholder{color:var(--muted)}
.btn{border:none;border-radius:10px;padding:12px 24px;color:white;font-size:14px;font-weight:600;cursor:pointer;width:100%;background:linear-gradient(135deg,var(--purple),var(--pink))}
.err{background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.3);border-radius:8px;padding:10px;color:var(--red);font-size:13px;margin-bottom:12px;display:none}

/* Nebula */
.nebula{position:fixed;border-radius:50%;pointer-events:none;z-index:0}
.content{position:relative;z-index:1}

/* Empty */
.empty{color:var(--muted);font-size:13px;padding:12px 0;text-align:center}

/* Tabs */
.tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:8px 16px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;font-size:13px;font-weight:600}
.tab.active{background:var(--purple);color:white;border-color:var(--purple)}

/* Delete btn */
.del-btn{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);border-radius:6px;padding:4px 10px;color:var(--red);cursor:pointer;font-size:11px}
</style>
</head>
<body>

<div class="nebula" style="top:-100px;right:-80px;width:300px;height:300px;background:radial-gradient(circle,rgba(168,85,247,.2),transparent 70%)"></div>
<div class="nebula" style="bottom:0;left:-80px;width:280px;height:280px;background:radial-gradient(circle,rgba(236,72,153,.14),transparent 70%)"></div>

<!-- LOGIN -->
<div id="login-screen" class="content">
  <div class="login-card">
    <div class="emoji">ğŸ›¡ï¸</div>
    <h2>Admin Panel</h2>
    <p>Galaxy Dashboard â€” Admin Access</p>
    <div class="err" id="err"></div>
    <input class="inp" id="admin-user" placeholder="Admin username" onkeydown="if(event.key==='Enter')doLogin()"/>
    <input class="inp" id="admin-pass" type="password" placeholder="Admin password" onkeydown="if(event.key==='Enter')doLogin()"/>
    <button class="btn" onclick="doLogin()">ğŸš€ Login as Admin</button>
  </div>
</div>

<!-- MAIN -->
<div id="main-screen" class="content">
  <div class="header">
    <div>
      <h1>ğŸŒŒ Galaxy Admin Panel</h1>
      <p>Manage all users and their data</p>
    </div>
    <button class="logout-btn" onclick="doLogout()">Logout</button>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card"><div class="num" id="s-users" style="color:var(--purple)">0</div><div class="lbl">ğŸ‘¥ Total Users</div></div>
      <div class="stat-card"><div class="num" id="s-expenses" style="color:var(--pink)">0</div><div class="lbl">ğŸ’¸ Expenses</div></div>
      <div class="stat-card"><div class="num" id="s-todos" style="color:var(--blue)">0</div><div class="lbl">âœ… Tasks</div></div>
      <div class="stat-card"><div class="num" id="s-habits" style="color:var(--green)">0</div><div class="lbl">ğŸ”¥ Habits</div></div>
      <div class="stat-card"><div class="num" id="s-goals" style="color:var(--yellow)">0</div><div class="lbl">ğŸ¯ Goals</div></div>
      <div class="stat-card"><div class="num" id="s-reflections" style="color:var(--cyan)">0</div><div class="lbl">ğŸ“– Reflections</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('users',this)">ğŸ‘¥ Users</button>
      <button class="tab" onclick="showTab('expenses',this)">ğŸ’¸ Expenses</button>
      <button class="tab" onclick="showTab('todos',this)">âœ… Tasks</button>
      <button class="tab" onclick="showTab('habits',this)">ğŸ”¥ Habits</button>
      <button class="tab" onclick="showTab('goals',this)">ğŸ¯ Goals</button>
      <button class="tab" onclick="showTab('reflections',this)">ğŸ“– Reflections</button>
    </div>

    <!-- USERS TAB -->
    <div id="tab-users">
      <div class="card">
        <div class="card-title">ğŸ‘¥ All Users</div>
        <input class="search-bar" placeholder="ğŸ” Search users..." oninput="filterUsers(this.value)"/>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Username</th>
                <th>Expenses</th>
                <th>Tasks</th>
                <th>Habits</th>
                <th>Goals</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- EXPENSES TAB -->
    <div id="tab-expenses" style="display:none">
      <div class="card">
        <div class="card-title">ğŸ’¸ All Expenses</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>User</th><th>Amount</th><th>Category</th><th>Note</th><th>Date</th></tr></thead>
            <tbody id="expenses-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TODOS TAB -->
    <div id="tab-todos" style="display:none">
      <div class="card">
        <div class="card-title">âœ… All Tasks</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>User</th><th>Task</th><th>Status</th></tr></thead>
            <tbody id="todos-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- HABITS TAB -->
    <div id="tab-habits" style="display:none">
      <div class="card">
        <div class="card-title">ğŸ”¥ All Habits</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>User</th><th>Habit</th></tr></thead>
            <tbody id="habits-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- GOALS TAB -->
    <div id="tab-goals" style="display:none">
      <div class="card">
        <div class="card-title">ğŸ¯ All Goals</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>User</th><th>Goal</th><th>Progress</th><th>Target</th><th>Status</th></tr></thead>
            <tbody id="goals-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- REFLECTIONS TAB -->
    <div id="tab-reflections" style="display:none">
      <div class="card">
        <div class="card-title">ğŸ“– All Reflections</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>User</th><th>Date</th><th>Rating</th><th>Note</th></tr></thead>
            <tbody id="reflections-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const API=async(url,method="GET",body)=>{
  const opts={method,credentials:"include",headers:{"Content-Type":"application/json"}};
  if(body)opts.body=JSON.stringify(body);
  const r=await fetch(url,opts);
  return r.json();
};

let allData={};

async function doLogin(){
  const u=document.getElementById("admin-user").value.trim();
  const p=document.getElementById("admin-pass").value;
  const r=await API("/api/admin/login","POST",{username:u,password:p});
  if(r.error){const e=document.getElementById("err");e.textContent=r.error;e.style.display="block";return;}
  document.getElementById("login-screen").style.display="none";
  document.getElementById("main-screen").style.display="block";
  loadAll();
}

async function doLogout(){
  await API("/api/admin/logout","POST");
  location.reload();
}

async function loadAll(){
  const r=await API("/api/admin/data");
  if(r.error){alert(r.error);return;}
  allData=r;
  renderStats();
  renderUsers();
  renderExpenses();
  renderTodos();
  renderHabits();
  renderGoals();
  renderReflections();
}

function renderStats(){
  document.getElementById("s-users").textContent=allData.users.length;
  document.getElementById("s-expenses").textContent=allData.expenses.length;
  document.getElementById("s-todos").textContent=allData.todos.length;
  document.getElementById("s-habits").textContent=allData.habits.length;
  document.getElementById("s-goals").textContent=allData.goals.length;
  document.getElementById("s-reflections").textContent=allData.reflections.length;
}

function getUserName(uid){
  const u=allData.users.find(u=>u.id===uid);
  return u?u.display_name:"Unknown";
}

function renderUsers(filter=""){
  const tbody=document.getElementById("users-tbody");
  const users=allData.users.filter(u=>
    u.display_name.toLowerCase().includes(filter.toLowerCase())||
    u.username.toLowerCase().includes(filter.toLowerCase())
  );
  if(!users.length){tbody.innerHTML='<tr><td colspan="7" class="empty">No users found</td></tr>';return;}
  tbody.innerHTML=users.map(u=>{
    const exp=allData.expenses.filter(e=>e.user_id===u.id).length;
    const todos=allData.todos.filter(t=>t.user_id===u.id).length;
    const habits=allData.habits.filter(h=>h.user_id===u.id).length;
    const goals=allData.goals.filter(g=>g.user_id===u.id).length;
    const totalExp=allData.expenses.filter(e=>e.user_id===u.id).reduce((s,e)=>s+e.amount,0);
    return`<tr>
      <td><div class="user-cell"><div class="avatar">${u.display_name[0].toUpperCase()}</div><strong>${u.display_name}</strong></div></td>
      <td><span class="badge badge-purple">@${u.username}</span></td>
      <td><span class="badge badge-pink">â‚¹${totalExp.toFixed(0)} (${exp})</span></td>
      <td><span class="badge badge-blue">${todos}</span></td>
      <td><span class="badge badge-green">${habits}</span></td>
      <td><span class="badge badge-yellow">${goals}</span></td>
      <td><button class="detail-btn" onclick="toggleDetail(${u.id})">View Details</button>
        <div class="detail-panel" id="detail-${u.id}">
          ${renderUserDetail(u.id)}
        </div>
      </td>
    </tr>`;
  }).join("");
}

function renderUserDetail(uid){
  const exps=allData.expenses.filter(e=>e.user_id===uid);
  const todos=allData.todos.filter(t=>t.user_id===uid);
  const habits=allData.habits.filter(h=>h.user_id===uid);
  const goals=allData.goals.filter(g=>g.user_id===uid);
  const refs=allData.reflections.filter(r=>r.user_id===uid);
  return`
    <div class="detail-section">
      <h4>ğŸ’¸ Recent Expenses</h4>
      ${exps.length?exps.slice(0,5).map(e=>`<div class="detail-item">â‚¹${e.amount} â€” ${e.category}${e.note?" ("+e.note+")":""} â€” ${e.date}</div>`).join(""):'<div class="detail-item empty">No expenses</div>'}
    </div>
    <div class="detail-section">
      <h4>âœ… Tasks (${todos.length})</h4>
      ${todos.length?todos.slice(0,5).map(t=>`<div class="detail-item">${t.done?"âœ…":"â¬œ"} ${t.text}</div>`).join(""):'<div class="detail-item empty">No tasks</div>'}
    </div>
    <div class="detail-section">
      <h4>ğŸ”¥ Habits (${habits.length})</h4>
      ${habits.length?habits.map(h=>`<div class="detail-item">ğŸ”¥ ${h.name}</div>`).join(""):'<div class="detail-item empty">No habits</div>'}
    </div>
    <div class="detail-section">
      <h4>ğŸ¯ Goals (${goals.length})</h4>
      ${goals.length?goals.map(g=>`<div class="detail-item">${g.done?"âœ…":"ğŸ¯"} ${g.title} â€” ${g.progress}%</div>`).join(""):'<div class="detail-item empty">No goals</div>'}
    </div>
    <div class="detail-section">
      <h4>ğŸ“– Recent Reflections</h4>
      ${refs.length?refs.slice(0,3).map(r=>`<div class="detail-item">${"â­".repeat(r.rating)} ${r.date}${r.note?" â€” "+r.note:""}</div>`).join(""):'<div class="detail-item empty">No reflections</div>'}
    </div>`;
}

function toggleDetail(uid){
  const panel=document.getElementById("detail-"+uid);
  panel.classList.toggle("open");
}

function filterUsers(val){renderUsers(val);}

function renderExpenses(){
  const tbody=document.getElementById("expenses-tbody");
  if(!allData.expenses.length){tbody.innerHTML='<tr><td colspan="5" class="empty">No expenses</td></tr>';return;}
  tbody.innerHTML=allData.expenses.map(e=>`<tr>
    <td><span class="badge badge-purple">${getUserName(e.user_id)}</span></td>
    <td><strong style="color:var(--pink)">â‚¹${parseFloat(e.amount).toFixed(2)}</strong></td>
    <td><span class="badge badge-blue">${e.category}</span></td>
    <td style="color:var(--muted)">${e.note||"-"}</td>
    <td style="color:var(--muted)">${e.date}</td>
  </tr>`).join("");
}

function renderTodos(){
  const tbody=document.getElementById("todos-tbody");
  if(!allData.todos.length){tbody.innerHTML='<tr><td colspan="3" class="empty">No tasks</td></tr>';return;}
  tbody.innerHTML=allData.todos.map(t=>`<tr>
    <td><span class="badge badge-purple">${getUserName(t.user_id)}</span></td>
    <td>${t.text}</td>
    <td><span class="badge ${t.done?"badge-green":"badge-yellow"}">${t.done?"âœ… Done":"â³ Active"}</span></td>
  </tr>`).join("");
}

function renderHabits(){
  const tbody=document.getElementById("habits-tbody");
  if(!allData.habits.length){tbody.innerHTML='<tr><td colspan="2" class="empty">No habits</td></tr>';return;}
  tbody.innerHTML=allData.habits.map(h=>`<tr>
    <td><span class="badge badge-purple">${getUserName(h.user_id)}</span></td>
    <td>ğŸ”¥ ${h.name}</td>
  </tr>`).join("");
}

function renderGoals(){
  const tbody=document.getElementById("goals-tbody");
  if(!allData.goals.length){tbody.innerHTML='<tr><td colspan="5" class="empty">No goals</td></tr>';return;}
  tbody.innerHTML=allData.goals.map(g=>`<tr>
    <td><span class="badge badge-purple">${getUserName(g.user_id)}</span></td>
    <td>${g.title}</td>
    <td>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden">
          <div style="height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));width:${g.progress}%;border-radius:3px"></div>
        </div>
        <span style="color:var(--cyan);font-size:12px">${g.progress}%</span>
      </div>
    </td>
    <td style="color:var(--muted)">${g.target_date||"-"}</td>
    <td><span class="badge ${g.done?"badge-green":"badge-yellow"}">${g.done?"âœ… Done":"ğŸ¯ Active"}</span></td>
  </tr>`).join("");
}

function renderReflections(){
  const tbody=document.getElementById("reflections-tbody");
  if(!allData.reflections.length){tbody.innerHTML='<tr><td colspan="4" class="empty">No reflections</td></tr>';return;}
  tbody.innerHTML=allData.reflections.map(r=>`<tr>
    <td><span class="badge badge-purple">${getUserName(r.user_id)}</span></td>
    <td style="color:var(--muted)">${r.date}</td>
    <td>${"â­".repeat(r.rating)}</td>
    <td style="color:var(--muted);max-width:300px">${r.note||"-"}</td>
  </tr>`).join("");
}

function showTab(name,btn){
  ["users","expenses","todos","habits","goals","reflections"].forEach(t=>{
    document.getElementById("tab-"+t).style.display=t===name?"block":"none";
  });
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

// Check if already logged in as admin
(async()=>{
  const r=await API("/api/admin/check");
  if(r.ok){
    document.getElementById("login-screen").style.display="none";
    document.getElementById("main-screen").style.display="block";
    loadAll();
  }
})();
</script>
</body>
</html>
